var mysql = require("mysql");
const connect = require("../config/conn");

function select_panelcap(callback, req) {
    //var global.datax;
    var con = mysql.createPool({
        host: connect.host,
        user: connect.user,
        password: connect.password,
        database: connect.database,
        port: connect.port,
    });

    con.getConnection(function (err, connection) {
        con.query(
            `
            SELECT * FROM \`product_panelcap\`
        `,
            function (error, rows, fields) {
                if (error) {
                    callback(error, {rows: rows, fields: fields});
                } else {
                    callback("success", {rows: rows, fields: fields});
                }
                con.end();
            }
        );
    });
}

function select_warna_panelcap(callback, req) {
    //var global.datax;
    var con = mysql.createPool({
        host: connect.host,
        user: connect.user,
        password: connect.password,
        database: connect.database,
        port: connect.port,
    });

    con.getConnection(function (err, connection) {
        con.query(
            `
            SELECT DISTINCT warna as warna ,kode FROM \`product_panelcap\` where amount >=0;
        `,
            function (error, rows, fields) {
                if (error) {
                    callback(error, {rows: rows, fields: fields});
                } else {
                    callback("success", {rows: rows, fields: fields});
                }
                con.end();
            }
        );
    });
}

function select_size_panelcap(callback, req) {
    //var global.datax;
    var con = mysql.createPool({
        host: connect.host,
        user: connect.user,
        password: connect.password,
        database: connect.database,
        port: connect.port,
    });

    var option = ``;
    if (req.body.warna) {
        option += ` WHERE warna = '${req.body.warna}' `;
    }

    con.getConnection(function (err, connection) {
        con.query(
            `
            SELECT size FROM \`product_panelcap\` ${option} and amount >=0;;
        `,
            function (error, rows, fields) {
                if (error) {
                    callback(error, {rows: rows, fields: fields});
                } else {
                    callback("success", {rows: rows, fields: fields});
                }
                con.end();
            }
        );
    });
}

function delete_panelcap(callback, req) {
    //var global.datax;
    var con = mysql.createPool({
        host: connect.host,
        user: connect.user,
        password: connect.password,
        database: connect.database,
        port: connect.port,
    });

    var option = ``;
    if (req.params.idproductpanelcap) {
        option += ` WHERE idproductpanelcap = '${req.params.idproductpanelcap}' `;
    }

    con.getConnection(function (err, connection) {
        con.query(`DELETE FROM product_panelcap ${option}`, function (error, rows, fields) {
            if (error) {
                callback(error, {rows: rows, fields: fields});
            } else {
                callback("success", {rows: rows, fields: fields});
            }
            con.end();
        });
    });
}

function update_panelcap(callback, req) {
    //var global.datax;
    var con = mysql.createPool({
        host: connect.host,
        user: connect.user,
        password: connect.password,
        database: connect.database,
        port: connect.port,
    });

    con.getConnection(function (err, connection) {
        con.query(
            `UPDATE product_panelcap
            SET amount = amount+'${req.body.amount}'
            WHERE idproductpanelcap = ${req.body.idproductpanelcap}`,
            function (error, rows, fields) {
                if (error) {
                    callback(error, {rows: rows, fields: fields});
                } else {
                    callback("success", {rows: rows, fields: fields});
                }
                con.end();
            }
        );
    });
}

function insert_panelcap(callback, req) {
    //var global.datax;
    var con = mysql.createPool({
        host: connect.host,
        user: connect.user,
        password: connect.password,
        database: connect.database,
        port: connect.port,
    });

    con.getConnection(function (err, connection) {
        con.query(
            `INSERT INTO product_panelcap
            (kode, jenisbarang, size, amount, hargabeli, hargajual, warna)
            VALUES ('${req.body.kode}', '${req.body.jenisbarang}','${req.body.size}','${req.body.amount}','${req.body.hargabeli}','${req.body.hargajual}','${req.body.warna}')
            `,
            function (error, rows, fields) {
                if (error) {
                    callback(error, {rows: rows, fields: fields});
                } else {
                    callback("success", {rows: rows, fields: fields});
                }
                con.end();
            }
        );
    });
}

function select_price(callback, req) {
    //var global.datax;
    var con = mysql.createPool({
        host: connect.host,
        user: connect.user,
        password: connect.password,
        database: connect.database,
        port: connect.port,
    });

    con.getConnection(function (err, connection) {
        con.query(
            `
            SELECT idproductpanelcap product_id_spec,hargajual price FROM \`product_panelcap\`
            WHERE size = '${req.query.size}' and warna = '${req.query.warna}'
        `,
            function (error, rows, fields) {
                if (error) {
                    callback(error, {rows: rows, fields: fields});
                } else {
                    callback("success", {rows: rows, fields: fields});
                }
                con.end();
            }
        );
    });
}

function update_amount(callback, req) {
    //var global.datax;
    var con = mysql.createPool({
        host: connect.host,
        user: connect.user,
        password: connect.password,
        database: connect.database,
        port: connect.port,
    });

    con.getConnection(function (err, connection) {
        con.query(
            `UPDATE product_panelcap
            SET amount = amount-'${req.body.amount}'
            WHERE size = '${req.body.size}' and warna = '${req.body.warna}' `,
            function (error, rows, fields) {
                if (error) {
                    callback(error, {rows: rows, fields: fields});
                } else {
                    callback("success", {rows: rows, fields: fields});
                }
                con.end();
            }
        );
    });
}

module.exports.insert_panelcap = insert_panelcap;
module.exports.update_panelcap = update_panelcap;
module.exports.select_panelcap = select_panelcap;
module.exports.delete_panelcap = delete_panelcap;

module.exports.select_size_panelcap = select_size_panelcap;
module.exports.select_warna_panelcap = select_warna_panelcap;

module.exports.select_price = select_price;
module.exports.update_amount = update_amount;
